/*
 * (c) Copyright 2005-2012 JAXIO, www.jaxio.com
 * Source code generated by Celerio, a Jaxio product
 * Want to use Celerio within your company? email us at info@jaxio.com
 * Follow us on twitter: @springfuse
 * Template pack-jsf2-primefaces:src/main/java/util/MessageUtil.p.vm.java
 */
package fr.jaxio.demo.web.util;

import static javax.faces.application.FacesMessage.SEVERITY_ERROR;
import static javax.faces.application.FacesMessage.SEVERITY_FATAL;
import static javax.faces.application.FacesMessage.SEVERITY_INFO;
import static javax.faces.application.FacesMessage.SEVERITY_WARN;

import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;
import javax.faces.application.FacesMessage;
import javax.faces.application.FacesMessage.Severity;
import javax.faces.context.FacesContext;

import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.dao.OptimisticLockingFailureException;

import fr.jaxio.demo.util.ResourcesUtil;

/**
 * Convenient bean to create JSF info/warn/error messsages from your flow.
 */
@Named
@Singleton
public class MessageUtil {

    @Inject
    private ResourcesUtil resourcesUtil;

    public static String toCssFriendly(Severity severity) {
        if (severity.equals(SEVERITY_INFO)) {
            return "info";
        } else if (severity.equals(SEVERITY_WARN)) {
            return "warn";
        } else if (severity.equals(SEVERITY_ERROR)) {
            return "error";
        } else if (severity.equals(SEVERITY_FATAL)) {
            return "fatal";
        }

        throw new IllegalStateException("Unexpected message severity: " + severity.toString());
    }

    public void info(String summaryKey, Object... args) {
        addFacesMessage(SEVERITY_INFO, summaryKey, args);
    }

    public void infoText(String summaryText) {
        addFacesTextMessage(SEVERITY_INFO, summaryText);
    }

    public void warning(String summaryKey, Object... args) {
        addFacesMessage(SEVERITY_WARN, summaryKey, args);
    }

    public void warningText(String summaryText) {
        addFacesTextMessage(SEVERITY_WARN, summaryText);
    }

    public void error(String summaryKey, Object... args) {
        addFacesMessage(SEVERITY_ERROR, summaryKey, args);
    }

    public void errorText(String summaryText) {
        addFacesTextMessage(SEVERITY_ERROR, summaryText);
    }

    public void error(Exception e) {
        if (isCausedBy(e, DataIntegrityViolationException.class)) {
            error("error_unique_constraint_violation");
        } else if (isCausedBy(e, OptimisticLockingFailureException.class)) {
            error("error_concurrent_modification");
        } else {
            error("status_exception_ko", getMessage(e));
        }
    }

    private boolean isCausedBy(Throwable e, Class<?> cause) {
        Throwable current = e;
        while (current != null) {
            if (cause.isAssignableFrom(current.getClass())) {
                return true;
            }
            current = current.getCause();
        }
        return false;
    }

    private String getMessage(Throwable e) {
        String message = e.getClass().getCanonicalName();
        Throwable current = e;
        while (current != null) {
            if (current.getMessage() != null && !current.getMessage().trim().isEmpty()) {
                message = current.getMessage();
            }
            current = current.getCause();
        }
        return message;
    }

    private void addFacesMessage(Severity severity, String summaryKey, Object[] args) {
        FacesMessage fm = new FacesMessage(resourcesUtil.getProperty(summaryKey, args));
        fm.setSeverity(severity);
        FacesContext.getCurrentInstance().addMessage(null, fm);
    }

    private void addFacesTextMessage(Severity severity, String text) {
        FacesMessage fm = new FacesMessage(text);
        fm.setSeverity(severity);
        FacesContext.getCurrentInstance().addMessage(null, fm);
    }
}